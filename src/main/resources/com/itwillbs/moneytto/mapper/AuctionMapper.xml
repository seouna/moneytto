<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itwillbs.moneytto.mapper.AuctionMapper">

	<select id="selectAuction" resultType="hashmap">
	 SELECT 
		 auction_code
	   , auction_type
	   , auction_item_name
	   , auction_content
	   , auction_present_price
	   , auction_immediate_price
	   , DATE_FORMAT(auction_date, '%Y.%m.%d %H:%i') 'auction_date'
	   , DATE_FORMAT(auction_start_date, '%Y.%m.%d %H:%i') 'auction_start_date'
	   , DATE_FORMAT(auction_end_date, '%Y.%m.%d %H:%i') 'auction_end_date'
	   , auction_status
	   , auction_notice
	   , auction_category
	   , image_code
	   , table_code
	   , image_name
	 		FROM auction a JOIN images i
	 			ON a.auction_code = i.table_code
	</select>
	
	<select id="selectAuctionCode" resultType="hashmap">
		SELECT 
			 auction_code
		   , auction_type
		   , auction_item_name
		   , auction_content
		   , auction_present_price
		   , auction_immediate_price
		   , DATE_FORMAT(auction_date, '%Y.%m.%d %H:%i') 'auction_date'
		   , DATE_FORMAT(auction_start_date, '%Y.%m.%d %H:%i') 'auction_start_date'
		   , DATE_FORMAT(auction_end_date, '%Y.%m.%d %H:%i') 'auction_end_date'
		   , auction_status
		   , auction_notice
		   , auction_category
		   , image_code
		   , table_code
		   , image_name
		 		FROM auction a JOIN images i
		 			ON a.auction_code = i.table_code
	 					WHERE auction_code = #{auction_code}
	</select>
	
	<insert id="insertEnroll">
		INSERT INTO auction_enroll 
					VALUES(
						  ((SELECT *
	  							FROM 
	  								(SELECT IFNULL(MAX(CAST(enroll_code AS UNSIGNED)) ,0) FROM auction_enroll) A)+1)
						, #{auction_code}
						, #{id}
						, 'N'
					)
	</insert>
	
	<select id="selectAuctionEnroll" resultType="hashmap">
		SELECT * 
			FROM auction_enroll
				WHERE auction_code = #{auction_code} AND member_id = #{id}
			
	</select>

	<!-- 소켓 사용한 경매 기록 저장 -->
	<insert id="insertAuctionLog">
		INSERT 
			INTO auction_log
			VALUES (
				((SELECT *
			  		FROM 
			  			(SELECT IFNULL(MAX(CAST(log_code AS UNSIGNED)) ,0) FROM auction_log) A)+1)
				, #{auctionCode}
				, #{id}
				, #{messages}
				, now()
				)
	</insert>
	
	<!-- 경매 기록 방 -->
	<select id="selectAuctionRoom" resultType="hashmap">
		SELECT *
			FROM auction_log
			<!-- 조건 만족 안하는걸 어떻게 하지? -->
			WHERE 
				auction_code = #{auction_code}
	</select>
	
	<!-- 경매 상세 기록 검색 -->
	<select id="selectAuctionLog" resultType="hashmap">
		SELECT 
			  log_code
			, auction_code
			, member_id
			, log_content
			, DATE_FORMAT(log_time, '%H:%i') 'log_time'
				FROM auction_log
					WHERE auction_code = #{auction_code}
	</select>
	
	<!-- 경매 마지막 로그 검색 -->
	<select id="selectLastLog" resultType="hashmap">
		SELECT *
			FROM auction_log
					ORDER BY log_time DESC LIMIT 1
	</select>
	
	
	
	
	
	<!-- 경매 기록 방 저장 -->
<!-- 	<insert id="insertAuctionRoom"> -->
<!-- 		INSERT -->
<!-- 			INTO chat_rooms( -->
<!-- 				1 -->
<!-- 				, #{auction_code} -->
<!-- 				, "물음표" -->
<!-- 				, now() -->
<!-- 			) -->
<!-- 	</insert> -->

</mapper>
